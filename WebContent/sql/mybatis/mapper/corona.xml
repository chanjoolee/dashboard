<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="">

	<select id="dashboard.corona.summary" resultType="hashmap">
		
	
		with tbl_data as (
			select
				m.SAMPLE,
				m.FIRMWARE,
				m.CATEGORY,
				m.TEST_ITEM,
				count(*) total_count,
				count(case when m.status = 'PASS' then 1 else null end) pass_count,
				count(case when m.status = 'FAIL' then 1 else null end) fail_count
			from CORONA_FIRMWARE_SCRIPT_MAP m 
			join CORONA_FIRMWARE_MASTER f
				on f.firmware = m.firmware
				and f.sample = m.sample				
			where 1=1		
			--and m.FIRMWARE = 'U3AE351C5419'
			--and m.SAMPLE = 'Armstrong3D_S36_128Gb_32GB'
			and m.FIRMWARE = #{firmware}
			and m.SAMPLE = #{sample}
			group by 
				m.FIRMWARE,
				m.SAMPLE,
				m.CATEGORY,
				m.TEST_ITEM
			--order by m.CATEGORY,m.TEST_ITEM
		)	,
		tbl_order as (
			select 'Protocol' CATEGORY , 1 as seq from dual  union all
			select 'Functional Test' CATEGORY , 2 as seq from dual  union all
			select 'Write Stress' CATEGORY , 3 as seq from dual  union all
			select 'Read Stress' CATEGORY , 4 as seq from dual  union all
			select 'SPOR Test' CATEGORY , 5 as seq from dual  union all
			select 'Lesson Learn' CATEGORY , 6 as seq from dual  		
		)	
		select 
			a.FIRMWARE,
			a.SAMPLE,
			a.CATEGORY,
			a.TEST_ITEM,
			a.TOTAL_COUNT,
			a.PASS_COUNT,		
			c.WEIGHT,
			c.COMPUTE_CRETERIA,
			--nvl(c.COMPUTE_CRETERIA,'None') COMPUTE_CRETERIA,
			c.COMPUTE_VALUE,
			c.TEST_STATE as "testState" ,
			case 
				when c.COMPUTE_CRETERIA = 'hrs' Then 96
				when c.COMPUTE_CRETERIA = 'sec' Then 86400
				when c.COMPUTE_CRETERIA = 'step' Then 868
				when c.COMPUTE_CRETERIA = 'min' Then 10000
				else null
			end as max_value,
			a.FAIL_COUNT
			
		from tbl_data  a
		left outer join tbl_order b
			 on a.CATEGORY = b.CATEGORY
		left outer join CORONA_TESTITEM_MASTER c
			on c.FIRMWARE = a.FIRMWARE
			and c.SAMPLE = a.SAMPLE
			and c.CATEGORY = a.CATEGORY
			and c.TEST_ITEM = a.TEST_ITEM
		order by b.seq , a.category, a.test_item
		
	</select>
	
	<select id="dashboard.corona.detail.last" resultType="hashmap">
		Select 
			*		
		From 
		(
			select
				A.*, ROWNUM AS ROW_NUM
			from 
			(
				select
					d.YYYYMM,
					d.TEST_BOARD,
					m.SAMPLE,
					m.FIRMWARE,
					d.SCRIPT_NAME,
					d.SAMPLE_NUMBER,
					d.SCRIPT,
					m.SCRIPT_NAME as SCRIPT_NAME_META,
					sm.CONVERT_SCRIPT,
					d.SEQ,
					d.TEST_TIME,
					nvl(m.STATUS,'Not Yet') as STATUS,
					d.STATUS_DETAIL,
					d.DURATION,	
					
					m.CATEGORY, 
					m.TEST_ITEM, 
					m.SINGLE_MULTI, 
					m.POWER_MODE_SPEED, 
					m.TEST_TIME TEST_TIME_MASTER, 
					m.NEED_VENDOR_CMD, 
					m.LUCONFIG_YN, 
					m.UFS_VER, 
					m.TARGET_OPERATION, 
					m.PRECONDITION, 
					m.POR, 
					m.HW_RESET, 
					m.EP_RESET, 
					m.H8, 
					m.SSU, 
					m.TARGET_LU, 
					m.POWER_CONTROL, 
					m.ITEM_NAME, 
					substr(m.ITEM_PURPOSE,1,20) || ' ...' as  ITEM_PURPOSE_SIMPLE ,
					m.ITEM_PURPOSE, 
					substr(m.ITEM_DESCRIPTION,1,20) || ' ...'  as  ITEM_DESCRIPTION_SIMPLE, 
					m.ITEM_DESCRIPTION,
					substr(REPLACE(m.INPUT_PARAMETER,CHR(10),' ,')  ,1,20) || ' ...' as INPUT_PARAMETER_SIMPLE,
					m.INPUT_PARAMETER,
					m.SCRIPT_TAT_LVL, 
					m.SCRIPT_VERSION, 
					m.PF110, 
					m.EXYNOS_7420, 
					m.P4_REV, 
					m.PRIORITY, 
					m.TG645, 
					substr(REPLACE(m.USER_COMMENT,CHR(10),' ,')  ,1,20) || ' ...' as USER_COMMENT_SIMPLE, 
					m.USER_COMMENT,
					m.JIRA,
					m.NEED_POWER_CYCLE, 
					m.RESET_YN, 
					m.SCRIPT_LVL, 
					m.REFACTORING, 
					m.RESET_TYPE
					
				from CORONA_FIRMWARE_SCRIPT_MAP m
				left outer join CORONA_TEST_DETAIL_last d
					on m.firmware = d.firmware
					and m.sample = d.sample
					and m.script_name = d.script
				left outer join CORONA_SCRIPT_MASTER sm 
					on sm.script_name = m.script_name
				where 1=1 
				<if test="sample != null and sample != '' " >and m.sample = #{sample}</if>
				<if test="firmware != null and firmware != '' " >and m.FIRMWARE = #{firmware}</if>
				<if test="category != null and category != '' " >and m.CATEGORY = #{category}</if>
				<if test="testItem != null and testItem != '' " > and m.test_item = #{testItem}</if>
				<if test="script_name != null and script_name != '' " > and m.script_name = #{script_name}</if>
				<if test="countGubun != null and countGubun != '' and countGubun == 'pass' " > and m.STATUS = 'PASS'</if>
				<if test="countGubun != null and countGubun != '' and countGubun == 'fail' " > and m.STATUS = 'FAIL'</if>
				<if test="countGubun != null and countGubun != '' and countGubun == 'notyet' " > and m.STATUS is null</if>
				
				order by m.SAMPLE,m.FIRMWARE, m.TEST_ITEM,d.YYYYMM,d.TEST_BOARD, d.SAMPLE, d.FIRMWARE, d.SCRIPT_NAME, d.SAMPLE_NUMBER, d.SCRIPT
			) A
			where 1=1 
			
			<choose>
				<when test="filters != null and filters != '' and (filters.rules.size() > 0  or (filters.groups != null and filters.groups.size() > 0) )">
					and (
					<if test="filters.rules.size() > 0" >
			       		<foreach collection="filters.rules" item="item" index="index"  open="(" separator="" close=")">
			           		<if test="index > 0 "> ${filters.groupOp} </if>   REGEXP_LIKE(${item.field}, REGEXP_REPLACE(#{item.data},' ','|'),'i')
			       		</foreach>	
			       	</if>	
			       	<if test="filters.groups != null and filters.groups.size() > 0">
		       			<foreach collection="filters.groups" item="group" index="group_index"  open=""  close="">
			       			<if test="group.rules.size() > 0">
			       			${filters.groupOp}
				           	<foreach collection="group.rules" item="rule" index="rule_index"  open="("   separator="" close=")">
					        	<if test="rule_index > 0 "> ${group.groupOp} </if> REGEXP_LIKE(${rule.field},#{rule.data},'i') 		           		 
					       	</foreach>
					       	</if>
				       	</foreach>
		       		</if> 
		       		 )
		   		</when>
	   		</choose>
	   		   
	   		
		) A
		where
    	<![CDATA[
	    	A.row_num >  to_number(#{rows}) * (to_number(#{page}) -1) 
	    	and A.row_num <= to_number(#{rows}) * to_number(#{page})
    	]]>
	</select>
	<select id="dashboard.corona.detail.last.page" resultType="hashmap">
		select 
				ceil(count(*)/ #{rows} ) as total,
				#{page} as page ,
				count(*) records 
			from 
			(
				select a.* from (
					select
						d.YYYYMM,
						d.TEST_BOARD,
						d.SAMPLE,
						d.FIRMWARE,
						d.SCRIPT_NAME,
						d.SAMPLE_NUMBER,
						d.SCRIPT,
						d.SEQ,
						d.TEST_TIME,
						nvl(d.STATUS,'Not Yet') as STATUS,
						d.STATUS_DETAIL,
						d.DURATION,	
						
						m.SCRIPT_NAME as SCRIPT_NAME_META,
						sm.CONVERT_SCRIPT,
						m.CATEGORY, 
						m.TEST_ITEM, 
						m.SINGLE_MULTI, 
						m.POWER_MODE_SPEED, 
						m.TEST_TIME TEST_TIME_MASTER, 
						m.NEED_VENDOR_CMD, 
						m.LUCONFIG_YN, 
						m.UFS_VER, 
						m.TARGET_OPERATION, 
						m.PRECONDITION, 
						m.POR, 
						m.HW_RESET, 
						m.EP_RESET, 
						m.H8, 
						m.SSU, 
						m.TARGET_LU, 
						m.POWER_CONTROL, 
						m.ITEM_NAME, 
						substr(m.ITEM_PURPOSE,1,20) || ' ...' as  ITEM_PURPOSE_SIMPLE ,
						m.ITEM_PURPOSE, 
						substr(m.ITEM_DESCRIPTION,1,20) || ' ...'  as  ITEM_DESCRIPTION_SIMPLE, 
						m.ITEM_DESCRIPTION,
						substr(REPLACE(m.INPUT_PARAMETER,CHR(10),' ,')  ,1,20) || ' ...' as INPUT_PARAMETER_SIMPLE,
						m.INPUT_PARAMETER,
						m.SCRIPT_TAT_LVL, 
						m.SCRIPT_VERSION, 
						m.PF110, 
						m.EXYNOS_7420, 
						m.P4_REV, 
						m.PRIORITY, 
						m.TG645, 
						m.USER_COMMENT, 
						m.JIRA,
						m.NEED_POWER_CYCLE, 
						m.RESET_YN, 
						m.SCRIPT_LVL, 
						m.REFACTORING, 
						m.RESET_TYPE
					from CORONA_FIRMWARE_SCRIPT_MAP m
					left outer join CORONA_TEST_DETAIL_last d
						on m.firmware = d.firmware
						and m.sample = d.sample
						and m.script_name = d.script
					left outer join CORONA_SCRIPT_MASTER sm 
						on sm.script_name = m.script_name
					where 1=1
					<if test="sample != null and sample != '' " >and m.sample = #{sample}</if>
					<if test="firmware != null and firmware != '' " >and m.FIRMWARE = #{firmware}</if>
					<if test="category != null and category != '' " >and m.CATEGORY = #{category}</if>
					<if test="testItem != null and testItem != '' " > and m.test_item = #{testItem}</if>
					<if test="script_name != null and script_name != '' " > and m.script_name = #{script_name}</if>
					<if test="countGubun != null and countGubun != '' and countGubun == 'pass' " > and m.STATUS = 'PASS'</if>
					<if test="countGubun != null and countGubun != '' and countGubun == 'fail' " > and m.STATUS = 'FAIL'</if>
					<if test="countGubun != null and countGubun != '' and countGubun == 'notyet' " > and m.STATUS is null</if>
					order by m.SAMPLE,m.FIRMWARE, m.TEST_ITEM,d.YYYYMM,d.TEST_BOARD, d.SAMPLE, d.FIRMWARE, d.SCRIPT_NAME, d.SAMPLE_NUMBER, d.SCRIPT
				) A
				where 1=1
				<choose>
					<when test="filters != null and filters != '' and (filters.rules.size() > 0  or (filters.groups != null and filters.groups.size() > 0) )">
						and (
						<if test="filters.rules.size() > 0" >
				       		<foreach collection="filters.rules" item="item" index="index"  open="(" separator="" close=")">
				           		<if test="index > 0 "> ${filters.groupOp} </if>   REGEXP_LIKE(${item.field}, REGEXP_REPLACE(#{item.data},' ','|'),'i')
				       		</foreach>	
				       	</if>	
				       	<if test="filters.groups != null and filters.groups.size() > 0">
			       			<foreach collection="filters.groups" item="group" index="group_index"  open=""  close="">
				       			<if test="group.rules.size() > 0">
				       			${filters.groupOp}
					           	<foreach collection="group.rules" item="rule" index="rule_index"  open="("   separator="" close=")">
						        	<if test="rule_index > 0 "> ${group.groupOp} </if> REGEXP_LIKE(${rule.field},#{rule.data},'i') 		           		 
						       	</foreach>
						       	</if>
					       	</foreach>
			       		</if> 
			       		 )
			   		</when>
	   			</choose>
			)
		
		
		
				
	</select>
	<select id="dashboard.corona.detail.subDetail" resultType="hashmap">
		
				select
					
					m.SAMPLE,
					m.FIRMWARE,
					m.SCRIPT_NAME,
					nvl(m.STATUS,'Not Yet') as STATUS,
					m.CATEGORY, 
					m.TEST_ITEM, 
					m.SINGLE_MULTI, 
					m.POWER_MODE_SPEED, 
					m.TEST_TIME TEST_TIME_MASTER, 
					m.NEED_VENDOR_CMD, 
					m.LUCONFIG_YN, 
					m.UFS_VER, 
					m.TARGET_OPERATION, 
					m.PRECONDITION, 
					m.POR, 
					m.HW_RESET, 
					m.EP_RESET, 
					m.H8, 
					m.SSU, 
					m.TARGET_LU, 
					m.POWER_CONTROL, 
					m.ITEM_NAME, 
					substr(m.ITEM_PURPOSE,1,20) || ' ...' as  ITEM_PURPOSE_SIMPLE ,
					m.ITEM_PURPOSE, 
					substr(m.ITEM_DESCRIPTION,1,20) || ' ...'  as  ITEM_DESCRIPTION_SIMPLE, 
					m.ITEM_DESCRIPTION,
					substr(REPLACE(m.INPUT_PARAMETER,CHR(10),' ,')  ,1,20) || ' ...' as INPUT_PARAMETER_SIMPLE,
					m.INPUT_PARAMETER,
					m.SCRIPT_TAT_LVL, 
					m.SCRIPT_VERSION, 
					m.PF110, 
					m.EXYNOS_7420, 
					m.P4_REV, 
					m.PRIORITY, 
					m.TG645, 
					substr(REPLACE(m.USER_COMMENT,CHR(10),' ,')  ,1,20) || ' ...' as USER_COMMENT_SIMPLE, 
					m.USER_COMMENT,
					m.JIRA,
					m.NEED_POWER_CYCLE, 
					m.RESET_YN, 
					m.SCRIPT_LVL, 
					m.REFACTORING, 
					m.RESET_TYPE
					
				from CORONA_FIRMWARE_SCRIPT_MAP m				
				where m.sample = #{sample}
				and m.FIRMWARE = #{firmware}
				and m.SCRIPT_NAME = #{script_name}
				
				
			
	</select>
	<select id="dashboard.corona.detail" resultType="hashmap">
		select
			d.YYYYMM,
			d.TEST_BOARD,
			d.SAMPLE,
			d.FIRMWARE,
			d.SCRIPT_NAME,
			d.SAMPLE_NUMBER,
			d.SCRIPT,	
			sm.CONVERT_SCRIPT,		
			d.SEQ,
			to_char(d.TEST_TIME,'YYYY-MM-DD HH24:MI:SS') as TEST_TIME,
			d.STATUS,
			d.STATUS_DETAIL,
			d.DURATION,
			s.FILE_NAME,
			s.FILA_PATH	
		from CORONA_TEST_DETAIL d
		left outer join CORONA_TEST_SUMMARY s
			on s.YYYYMM = d.YYYYMM
			and s.TEST_BOARD = d.TEST_BOARD
			and s.SAMPLE = d.SAMPLE
			and s.FIRMWARE = d.FIRMWARE
			and s.SCRIPT_NAME = d.SCRIPT_NAME
			and s.SAMPLE_NUMBER = d.SAMPLE_NUMBER
		left outer join CORONA_SCRIPT_MASTER sm
			on sm.script_name = d.script
		where 1=1
		and d.test_board = #{test_board}		
		and d.sample = #{sample}
		and d.FIRMWARE = #{firmware}
		and d.script = #{script}		
		order by d.YYYYMM,d.TEST_BOARD, d.SAMPLE, d.FIRMWARE, d.SCRIPT_NAME, d.SAMPLE_NUMBER, d.SCRIPT
				
	</select>
	<select id="dashboard.corona.search.firmware" resultType="hashmap">
		select 
			a.SAMPLE,
			a.FIRMWARE,
			a.FIRMWARE || '' 
			--case  
			--	when c.TEST_SET_ID  is not null then 
			--		'( ' || c.TEST_SET_NAME || ' )'
			--	else ''
			-- end 
			as FIRMWARE_NM,
			b.REQUEST_ID,
			(SELECT CASE WHEN CODE_ID = 'SPM_00005011' THEN 'eMMC' ELSE 'SSD' END FROM SOLUTIONPMS.PJT_BASE_INFO WHERE CODE_NAME = 'Application' AND PJT_ID = B.PJT_ID)  as APP_TYPE  ,
			b.RELEASE_STATUS_CD,
			SOLUTIONPMS.FN_CODE_VALUE_ID(b.RELEASE_STATUS_CD) RELEASE_STATUS_NM,
			b.VERIFY_RESULT_CD,
			SOLUTIONPMS.FN_CODE_VALUE_ID(b.VERIFY_RESULT_CD) VERIFY_RESULT_NM,
			c.TEST_SET_ID,
			c.TEST_SET_NAME
		from CORONA_FIRMWARE_MASTER A
		left outer join SOLUTIONPMS.FW_RELEASE b
			on A.firmware = b.fw_version
			and (SELECT CASE WHEN CODE_ID = 'SPM_00005011' THEN 'eMMC' ELSE 'SSD' END FROM SOLUTIONPMS.PJT_BASE_INFO WHERE CODE_NAME = 'Application' AND PJT_ID = B.PJT_ID) != 'SSD'
			and SOLUTIONPMS.FN_CODE_VALUE_ID(b.VERIFY_RESULT_CD) = 'Pass'
			and SOLUTIONPMS.FN_CODE_VALUE_ID(b.RELEASE_STATUS_CD) != 'Cancelled'
			and NVL(b.OVT_YN, 'N') = 'N'
		left outer join SOLUTIONPMS.FW_RELEASE_TEST_SET c
			on b.FVT_TEST_SET_ID = c.TEST_SET_ID
		where 1=1
		<choose>
			<when test="sample != null and sample != '' ">
				and a.sample = #{sample}
			</when>
			<otherwise>
				and 1 = 2
			</otherwise>
		</choose>
		order by 1
	</select>
	
	<select id="dashboard.corona.search.sample" resultType="hashmap">
		with tbl_project as (
			select
					distinct a.SAMPLE
				from CORONA_FIRMWARE_MASTER a
				where 1=1
				and not exists (
					select * from CORONA_PROJECT t
					where t.use_yn = 'N'
					and a.sample = t.project
				)
		)
		
		select 
			a.sample,
			b.use_yn,
			nvl(b.scriptset,'Normal') as default_scriptset
		from tbl_project a
		left outer join CORONA_PROJECT b
		on a.sample = b.project
		order by 1
	
	</select>
	<select id="dashboard.corona.scriptsets.search.by.fimware" resultType="hashmap">
		select
			SCRIPTSET
		from CORONA_SCRIPTSET_MAP_F
		where firmware = #{firmware}
		and sample= #{sample}
		
		
	</select>
	<update id="dashboard.corona.testitem.master.update" parameterType="hashmap">
    	declare
	    	cnt number;
	    begin
	    	
	    		select count(*) into cnt from CORONA_TESTITEM_MASTER
	    		where FIRMWARE = #{origindata.FIRMWARE}
                and  SAMPLE = #{origindata.SAMPLE}
                and  CATEGORY = #{origindata.CATEGORY} 
                and  TEST_ITEM = #{origindata.TEST_ITEM};
	    		
	    		if cnt = 1 then
	                update CORONA_TESTITEM_MASTER set
	                	WEIGHT = #{WEIGHT}, 
	                	COMPUTE_CRETERIA = #{COMPUTE_CRETERIA}, 
	                	COMPUTE_VALUE = #{COMPUTE_VALUE}, 
	  					TEST_STATE = #{testState},
	                	MOD_DT = sysdate
	                where FIRMWARE = #{origindata.FIRMWARE}
	                and  SAMPLE = #{origindata.SAMPLE}
	                and  CATEGORY = #{origindata.CATEGORY} 
	                and  TEST_ITEM = #{origindata.TEST_ITEM};
	          	else
	          		insert into CORONA_TESTITEM_MASTER(FIRMWARE, SAMPLE, CATEGORY, TEST_ITEM, WEIGHT, COMPUTE_CRETERIA, COMPUTE_VALUE, TEST_STATE, INS_DT)
	          		values (#{origindata.FIRMWARE}, #{origindata.SAMPLE}, #{origindata.CATEGORY}, #{origindata.TEST_ITEM}, #{WEIGHT}, #{COMPUTE_CRETERIA}, #{COMPUTE_VALUE},#{testState}, sysdate);
	          	
	          	end if;
                
       	 
	    end;
    
    </update>
	
	<select id="dashboard.corona.script.category.distinct" resultType="hashmap">
		select
			distinct category , 'SELECTED' selected
		from CORONA_SCRIPT_MASTER
		order by 1
	
	</select>
	
	<select id="dashboard.corona.script.test_item.distinct" resultType="hashmap">
		select
			distinct category, test_item , 'SELECTED' selected
		from CORONA_SCRIPT_MASTER
		order by 1
	
	</select>
	
	<select id="dashboard.corona.manage.script.search" resultType="hashmap">
		with tbl_a as (	
			SELECT
				SCRIPT_NAME, 
				CONVERT_SCRIPT,
				CATEGORY, 
				row_number() over (partition by category order by CATEGORY,SCRIPT_NAME) row_num,
				TEST_ITEM, 
				SINGLE_MULTI, 
				POWER_MODE_SPEED, 
				TEST_TIME, 
				NEED_VENDOR_CMD, 
				LUCONFIG_YN, 
				UFS_VER, 
				TARGET_OPERATION, 
				PRECONDITION, 
				POR, 
				HW_RESET, 
				EP_RESET, 
				H8, 
				SSU, 
				TARGET_LU, 
				POWER_CONTROL, 
				ITEM_NAME, 
				substr(ITEM_PURPOSE,1,20) || ' ...' as  ITEM_PURPOSE_SIMPLE ,
				nvl(ITEM_PURPOSE,' ' ) ITEM_PURPOSE, 
				substr(ITEM_DESCRIPTION,1,20) || ' ...'  as  ITEM_DESCRIPTION_SIMPLE, 
				ITEM_DESCRIPTION, 
				substr(REPLACE(INPUT_PARAMETER,CHR(10),' ,')  ,1,20) || ' ...' as INPUT_PARAMETER_SIMPLE,
				INPUT_PARAMETER, 
				SCRIPT_TAT_LVL, 
				SCRIPT_VERSION, 
				PF110, 
				EXYNOS_7420, 
				P4_REV, 
				PRIORITY, 
				TG645, 
				substr(REPLACE(USER_COMMENT,CHR(10),' ,')  ,1,20) || ' ...' as USER_COMMENT_SIMPLE, 
				USER_COMMENT, 		
				NEED_POWER_CYCLE, 
				RESET_YN, 
				SCRIPT_LVL, 
				REFACTORING, 
				RESET_TYPE,
				INS_DT, 
				MOD_DT
			from CORONA_SCRIPT_MASTER a
			where 1=1
			<if test="categoryArr  != null and categoryArr != '' ">
				and a.category in 
				<foreach collection="categoryArr" item="item" index="index" open="(" separator="," close=")" >
	       			#{item}
	       		</foreach>
			</if>
			<if test="testItemArr  != null and testItemArr != '' ">
				and a.test_item in 
				<foreach collection="testItemArr" item="item" index="index" open="(" separator="," close=")" >
	       			#{item}
	       		</foreach>
			</if>
			--order by category,test_item, script_name
			order by category ,script_name
		)
		
		select 
			case 
				when a.row_num > 0 and a.row_num <![CDATA[ <= ]]>  500 then '01. ~500'
				when a.row_num >500 and a.row_num <![CDATA[ <=  ]]> 1000 then '02. 500~1000'
				when a.row_num > 1000 and a.row_num <![CDATA[ <=  ]]> 1500 then '03. 1000~1500'
				when a.row_num > 1500 and a.row_num <![CDATA[ <=  ]]> 2000 then '04. 1500~2000'
				when a.row_num > 2000 then '05. 2000~'				
			end as rownum_grp
			,a.*
		from tbl_a a
	
	</select>
	
	<select id="dashboard.corona.manage.script.search.one" resultType="hashmap">
			SELECT
				SCRIPT_NAME, 
				CONVERT_SCRIPT,
				CATEGORY, 
				TEST_ITEM, 
				SINGLE_MULTI, 
				POWER_MODE_SPEED, 
				TEST_TIME, 
				NEED_VENDOR_CMD, 
				LUCONFIG_YN, 
				UFS_VER, 
				TARGET_OPERATION, 
				PRECONDITION, 
				POR, 
				HW_RESET, 
				EP_RESET, 
				H8, 
				SSU, 
				TARGET_LU, 
				POWER_CONTROL, 
				ITEM_NAME, 
				substr(ITEM_PURPOSE,1,20) || ' ...' as  ITEM_PURPOSE_SIMPLE ,
				nvl(ITEM_PURPOSE,' ' ) ITEM_PURPOSE, 
				substr(ITEM_DESCRIPTION,1,20) || ' ...'  as  ITEM_DESCRIPTION_SIMPLE, 
				ITEM_DESCRIPTION, 
				substr(REPLACE(INPUT_PARAMETER,CHR(10),' ,')  ,1,20) || ' ...' as INPUT_PARAMETER_SIMPLE,
				INPUT_PARAMETER, 
				SCRIPT_TAT_LVL, 
				SCRIPT_VERSION, 
				PF110, 
				EXYNOS_7420, 
				P4_REV, 
				PRIORITY, 
				TG645, 
				substr(REPLACE(USER_COMMENT,CHR(10),' ,')  ,1,20) || ' ...' as USER_COMMENT_SIMPLE, 
				USER_COMMENT, 		
				NEED_POWER_CYCLE, 
				RESET_YN, 
				SCRIPT_LVL, 
				REFACTORING, 
				RESET_TYPE,
				INS_DT, 
				MOD_DT
			from CORONA_SCRIPT_MASTER a
			where script_name = #{script_name}
			order by category,test_item, script_name
	
	</select>
	
	<select id="dashboard.corona.manage.script.firmware.mapping" resultType="hashmap">
		with tbl_a as (	
			SELECT
				m.SAMPLE,
				m.FIRMWARE,
				m.SCRIPT_NAME, 
				sm.CONVERT_SCRIPT,
				CATEGORY, 
				row_number() over (partition by m.category order by m.CATEGORY,m.SCRIPT_NAME) row_num,
				m.TEST_ITEM, 
				m.SINGLE_MULTI, 
				m.POWER_MODE_SPEED, 
				m.TEST_TIME, 
				m.NEED_VENDOR_CMD, 
				m.LUCONFIG_YN, 
				m.UFS_VER, 
				m.TARGET_OPERATION, 
				m.PRECONDITION, 
				m.POR, 
				m.HW_RESET, 
				m.EP_RESET, 
				m.H8, 
				m.SSU, 
				m.TARGET_LU, 
				m.POWER_CONTROL, 
				m.ITEM_NAME, 
				substr(m.ITEM_PURPOSE,1,20) || ' ...' as  ITEM_PURPOSE_SIMPLE ,
				nvl(m.ITEM_PURPOSE,' ' ) ITEM_PURPOSE, 
				substr(m.ITEM_DESCRIPTION,1,20) || ' ...'  as  ITEM_DESCRIPTION_SIMPLE, 
				m.ITEM_DESCRIPTION, 
				substr(REPLACE(m.INPUT_PARAMETER,CHR(10),' ,')  ,1,20) || ' ...' as INPUT_PARAMETER_SIMPLE,
				m.INPUT_PARAMETER, 
				m.SCRIPT_TAT_LVL, 
				m.SCRIPT_VERSION, 
				m.PF110, 
				m.EXYNOS_7420, 
				m.P4_REV, 
				m.PRIORITY, 
				m.TG645, 
				substr(REPLACE(m.USER_COMMENT,CHR(10),' ,')  ,1,20) || ' ...' as USER_COMMENT_SIMPLE, 
				m.USER_COMMENT, 		
				m.NEED_POWER_CYCLE, 
				m.RESET_YN, 
				m.SCRIPT_LVL, 
				m.REFACTORING, 
				m.RESET_TYPE,
				m.INS_DT, 
				m.MOD_DT
			from CORONA_FIRMWARE_SCRIPT_MAP m
			left outer join CORONA_SCRIPT_MASTER sm
				on sm.script_name = m.script_name
			where m.sample = #{sample}
			and m.FIRMWARE = #{firmware}
			order by m.category,m.test_item, m.script_name
		)
		select 
			case 
				when a.row_num > 0 and a.row_num <![CDATA[ <= ]]>  500 then '01. ~500'
				when a.row_num >500 and a.row_num <![CDATA[ <=  ]]> 1000 then '02. 500~1000'
				when a.row_num > 1000 and a.row_num <![CDATA[ <=  ]]> 1500 then '03. 1000~1500'
				when a.row_num > 1500 and a.row_num <![CDATA[ <=  ]]> 2000 then '04. 1500~2000'
				when a.row_num > 2000 then '05. 2000~'				
			end as rownum_grp
			,a.*
		from tbl_a a
		
	</select>
	<select id="dashboard.corona.manage.script.firmware.mapping.one" resultType="hashmap">
		
		SELECT
				m.SAMPLE,
				m.FIRMWARE,
				m.SCRIPT_NAME, 
				m.CATEGORY, 
				m.TEST_ITEM, 
				m.SINGLE_MULTI, 
				m.POWER_MODE_SPEED, 
				m.TEST_TIME, 
				m.NEED_VENDOR_CMD, 
				m.LUCONFIG_YN, 
				m.UFS_VER, 
				m.TARGET_OPERATION, 
				m.PRECONDITION, 
				m.POR, 
				m.HW_RESET, 
				m.EP_RESET, 
				m.H8, 
				m.SSU, 
				m.TARGET_LU, 
				m.POWER_CONTROL, 
				m.ITEM_NAME, 
				substr(m.ITEM_PURPOSE,1,20) || ' ...' as  ITEM_PURPOSE_SIMPLE ,
				nvl(m.ITEM_PURPOSE,' ' ) ITEM_PURPOSE, 
				substr(m.ITEM_DESCRIPTION,1,20) || ' ...'  as  ITEM_DESCRIPTION_SIMPLE, 
				m.ITEM_DESCRIPTION, 
				substr(REPLACE(m.INPUT_PARAMETER,CHR(10),' ,')  ,1,20) || ' ...' as INPUT_PARAMETER_SIMPLE,
				m.INPUT_PARAMETER, 
				m.SCRIPT_TAT_LVL, 
				m.SCRIPT_VERSION, 
				m.PF110, 
				m.EXYNOS_7420, 
				m.P4_REV, 
				m.PRIORITY, 
				m.TG645, 
				substr(REPLACE(m.USER_COMMENT,CHR(10),' ,')  ,1,20) || ' ...' as USER_COMMENT_SIMPLE, 
				m.USER_COMMENT, 		
				m.NEED_POWER_CYCLE, 
				m.RESET_YN, 
				m.SCRIPT_LVL, 
				m.REFACTORING, 
				m.RESET_TYPE,
				m.INS_DT, 
				m.MOD_DT
			from CORONA_FIRMWARE_SCRIPT_MAP m
			where m.sample = #{sample}
			and m.FIRMWARE = #{firmware}
			and m.script_name = #{script_name}
			order by m.category,m.test_item, m.script_name
		
	</select>
	
	<update id="dashboard.corona.script_master.update" parameterType="hashmap" >
    	declare
	    	cnt number;
	    	v_script_name varchar2(2000);
	    	v_convert_script varchar2(2000);
	    	v_status varchar2(10);
	    begin
	    	
	    		select count(*) into cnt from CORONA_SCRIPT_MASTER
	    		where 1=1
	    		<choose>
						<when test="searchJson != null and searchJson != '' and searchJson.origindatas.size() > 0 " >
			       		<foreach collection="searchJson.origindatas" item="item" index="index"  >
			       			and ${item.field} = #{item.value}
			       		</foreach>
			   		</when>
			   		<otherwise>
			   			and 1=2
			   		</otherwise>
		   		</choose>   
	    		;
	    		
	    		if cnt = 1 then
	              	update CORONA_SCRIPT_MASTER set
	              	${fieldName} = #{fieldValue},	  
	              	MOD_DT = sysdate
	              	where 1=1
		    		<choose>
						<when test="searchJson != null and searchJson != '' and searchJson.origindatas.size() > 0 " >
				       		<foreach collection="searchJson.origindatas" item="item" index="index"  >
				       			and ${item.field} = #{item.value}
				       		</foreach>
				   		</when>
				   		<otherwise>
				   			and 1=2
				   		</otherwise>
			   		</choose>          	
	          		;
	          	<if test= "fieldName != 'CONVERT_SCRIPT' ">
	          		update CORONA_SCRIPTSET_MAP set
	              	${fieldName} = #{fieldValue},	  
	              	MOD_DT = sysdate
	              	where 1=1
		    		<choose>
							<when test="searchJson != null and searchJson != '' and searchJson.origindatas.size() > 0 " >
				       		<foreach collection="searchJson.origindatas" item="item" index="index"  >
				       			and ${item.field} = #{item.value}
				       		</foreach>
				   		</when>
				   		<otherwise>
				   			and 1=2
				   		</otherwise>
			   		</choose>          	
	          		;
	          		
	          		
	          		update CORONA_FIRMWARE_SCRIPT_MAP set
	              	${fieldName} = #{fieldValue},	  
	              	MOD_DT = sysdate
	              	where 1=1
		    		<choose>
							<when test="searchJson != null and searchJson != '' and searchJson.origindatas.size() > 0 " >
				       		<foreach collection="searchJson.origindatas" item="item" index="index"  >
				       			and ${item.field} = #{item.value}
				       		</foreach>
				   		</when>
				   		<otherwise>
				   			and 1=2
				   		</otherwise>
			   		</choose>          	
	          		;
	          		
	          	</if>
	          	<if test= "fieldName == 'CONVERT_SCRIPT' ">
	          		update CORONA_TEST_DETAIL set
          			CONVERT_SCRIPT = #{fieldValue},
          			MOD_DT = sysdate
          			where CONVERT_SCRIPT = #{fieldValueOrigin};
	          	</if>
	          	<if test= "fieldName == 'SCRIPT_NAME' ">
	          		v_script_name := #{fieldValue}; 
	          			
          			--// update CORONA_SCRIPTSET_MAP
          			update CORONA_SCRIPTSET_MAP set
          			SCRIPT_NAME = #{fieldValue},
          			USER_COMMENT = USER_COMMENT || case when USER_COMMENT is not null then  chr(10) end  || to_char(sysdate,'YYYY-MM-DD HH24:MI') || ': ' || #{fieldValueOrigin} || ' ==> ' || #{fieldValue} || ' ( ${userId} )'  ,
          			MOD_DT = sysdate
          			where SCRIPT_NAME = #{fieldValueOrigin};
	          			
          			--// update_firmware_table	          			
          			update CORONA_FIRMWARE_SCRIPT_MAP set
          			SCRIPT_NAME = #{fieldValue},
          			USER_COMMENT = USER_COMMENT || case when USER_COMMENT is not null then  chr(10) end  || to_char(sysdate,'YYYY-MM-DD HH24:MI') || ': ' || #{fieldValueOrigin} || ' ==> ' || #{fieldValue} || ' ( ${userId} )'  ,
          			MOD_DT = sysdate
          			where SCRIPT_NAME = #{fieldValueOrigin};
	          			
				   		
			   		--// update_log_table
          			update CORONA_TEST_DETAIL set
          			SCRIPT = #{fieldValue},
          			MOD_DT = sysdate
          			where Script = #{fieldValueOrigin};
	          			
          			--// update_log_table
          			update CORONA_TEST_DETAIL_LAST set
          			SCRIPT = #{fieldValue},
          			MOD_DT = sysdate
          			where Script = #{fieldValueOrigin};
	          			
          			--// update_comment
          			update CORONA_SCRIPT_MASTER set
          			USER_COMMENT = USER_COMMENT || case when USER_COMMENT is not null then  chr(10) end  || to_char(sysdate,'YYYY-MM-DD HH24:MI') || ': ' || #{fieldValueOrigin} || ' ==> ' || #{fieldValue} || ' ( ${userId} )'  ,
          			MOD_DT = sysdate
          			where SCRIPT_NAME = #{fieldValue};
	          		
	          		--//  Status
	          		for rec_scriptset in (
	          			select SCRIPTSET from CORONA_SCRIPT_SETS
	          		) loop 
	          			for rec_firmwares in (
	          				select  FIRMWARE, SAMPLE, SCRIPTSET  from CORONA_SCRIPTSET_MAP_F
	          				where SCRIPTSET = rec_scriptset.SCRIPTSET
	          			) loop
	          				--//Start. status update
							v_status := null;
							for rec_detail in (
								select
									STATUS
								from CORONA_TEST_DETAIL a
								where a.sample= rec_firmwares.sample
								and a.firmware = rec_firmwares.firmware
								and a.script = v_script_name
								order by YYYYMM
							) loop
								v_status := rec_detail.STATUS;
								if rec_detail.STATUS = 'FAIL' then 
									exit;
								end if;
							end loop;
							
							UPDATE CORONA_FIRMWARE_SCRIPT_MAP SET						
								status = v_status
								,USER_COMMENT = USER_COMMENT || chr(10) || to_char(sysdate,'YYYY-MM-DD HH24:MI') || ': ' || STATUS || ' ==> ' || v_status || ' (management) '
								,MOD_DT = sysdate
							where firmware = rec_firmwares.firmware
							and sample = rec_firmwares.sample
							and script_name =  v_script_name;
							--// End. status update
							
	          				
	          			
	          			end loop;
	          			--// end rec_firmwares
	          			
	          		end loop;
	          		--// end rec_scriptset
	          		--// End Status  		
	          	</if>
	          		
	        end if;
                
       	 
	    end;
    
    </update>
    <update id="dashboard.corona.script_firmware.update" parameterType="hashmap" >
    	declare
	    	cnt number;
	    begin
	    	
	    		select count(*) into cnt from CORONA_FIRMWARE_SCRIPT_MAP
	    		where 1=1
	    		<choose>
						<when test="searchJson != null and searchJson != '' and searchJson.origindatas.size() > 0 " >
			       		<foreach collection="searchJson.origindatas" item="item" index="index"  >
			       			and ${item.field} = #{item.value}
			       		</foreach>
			   		</when>
			   		<otherwise>
			   			and 1=2
			   		</otherwise>
		   		</choose>   
	    		;
	    		
	    		if cnt = 1 then
	              	update CORONA_FIRMWARE_SCRIPT_MAP set
	              	${fieldName} = #{fieldValue},	  
	              	MOD_DT = sysdate
	              	where 1=1
		    		<choose>
							<when test="searchJson != null and searchJson != '' and searchJson.origindatas.size() > 0 " >
				       		<foreach collection="searchJson.origindatas" item="item" index="index"  >
				       			and ${item.field} = #{item.value}
				       		</foreach>
				   		</when>
				   		<otherwise>
				   			and 1=2
				   		</otherwise>
			   		</choose>          	
	          		;
	       
	        	end if;
                
       	 
	    end;
    
    </update>
    
    <update id="dashboard.corona.script_master.insert" parameterType="hashmap" >
    	Declare
	    	cnt number;
	    	v_status varchar2(100);
	    Begin
	    	
	   		insert into CORONA_SCRIPT_MASTER (SCRIPT_NAME, CATEGORY, TEST_ITEM, SCRIPT_TAT_LVL, SCRIPT_VERSION, INS_DT)
            values (#{SCRIPT_NAME},#{CATEGORY},#{TEST_ITEM}, #{SCRIPT_TAT_LVL}, #{SCRIPT_VERSION}, sysdate) ;
            
            select count(*) into cnt from CORONA_SCRIPTSET_MAP
            where SCRIPTSET = 'Normal'
            and SCRIPT_NAME = #{SCRIPT_NAME};
            
            if cnt = 0 then
            	insert into CORONA_SCRIPTSET_MAP (SCRIPTSET, SCRIPT_NAME, CATEGORY, TEST_ITEM, SCRIPT_TAT_LVL, SCRIPT_VERSION, INS_DT)
            	values ('Normal', #{SCRIPT_NAME},#{CATEGORY},#{TEST_ITEM}, #{SCRIPT_TAT_LVL}, #{SCRIPT_VERSION}, sysdate);
            end if;
	              
	        For rec_firmware in (
				select FIRMWARE, SAMPLE,SCRIPTSET from CORONA_SCRIPTSET_MAP_F
				where 1=1
				and SCRIPTSET = 'Normal'
			)
			Loop
				-- DELETE	
				delete from CORONA_FIRMWARE_SCRIPT_MAP 
				where FIRMWARE = rec_firmware.firmware
				and SAMPLE = rec_firmware.sample
				and SCRIPT_NAME = #{SCRIPT_NAME};
				-- INSERT
				insert into CORONA_FIRMWARE_SCRIPT_MAP (FIRMWARE, SAMPLE, SCRIPT_NAME, CATEGORY, TEST_ITEM, SCRIPT_TAT_LVL, SCRIPT_VERSION, INS_DT)
				select
					rec_firmware.firmware,
					rec_firmware.sample,
					SCRIPT_NAME, 
					CATEGORY,
					TEST_ITEM,
					#{SCRIPT_TAT_LVL}, 
					#{SCRIPT_VERSION},
					sysdate
				from CORONA_SCRIPTSET_MAP
				where SCRIPTSET = 'Normal'
				and script_name = #{SCRIPT_NAME};
					
					
				--// 04 STATUS UPDATE
				for rec_script in (
					select * from CORONA_FIRMWARE_SCRIPT_MAP 
					where firmware = rec_firmware.firmware and sample = rec_firmware.sample
					and script_name = #{SCRIPT_NAME}
				) loop 
					v_status := null;
					for rec_detail in (
						select
							STATUS
						from CORONA_TEST_DETAIL a
						where a.sample= rec_script.sample
						and a.firmware = rec_script.firmware
						and a.script = rec_script.script_name
						order by YYYYMM
					) loop
						v_status := rec_detail.STATUS;
						if rec_detail.STATUS = 'FAIL' then 
							exit;
						end if;
					end loop;
					
					UPDATE CORONA_FIRMWARE_SCRIPT_MAP SET						
						status = v_status,
						USER_COMMENT = USER_COMMENT || chr(10) || to_char(sysdate,'YYYY-MM-DD HH24:MI') || ': ' || STATUS || ' ==> ' || v_status || ' (system) ',
						MOD_DT = sysdate
					where firmware = rec_script.firmware
					and sample = rec_script.sample
					and script_name = rec_script.script_name;
				End Loop;
				--// END 04 STATUS UPDATE	
				
			End Loop;
       	 
	    End;
    
    </update>
    
    <update id="dashboard.corona.script_master.delete.back" parameterType="hashmap" >
    	declare
	    	cnt number;
	    begin
	    	
	    		delete from CORONA_SCRIPT_MASTER
	    		where 1=1
	    		<choose>
					<when test="searchJson != null and searchJson != '' and searchJson.delRows.size() > 0 " >
						and SCRIPT_NAME in 
			       		<foreach collection="searchJson.delRows" item="item" index="index"  open="(" separator="," close=")">
			       			#{item.SCRIPT_NAME}
			       		</foreach>
			   		</when>
			   		<otherwise>
			   			and 1=2
			   		</otherwise>
		   		</choose>    
		   		;
       	 
	    end;
    
    </update>
    <update id="dashboard.corona.script_master.delete" parameterType="hashmap" >
    	declare
	    	cnt number;
	    begin
	    	
	    		delete from CORONA_SCRIPT_MASTER
	    		where 1=1
	    		and SCRIPT_NAME = #{detail.SCRIPT_NAME};
	    		
	    		--// 01. delete script set
	    		delete from CORONA_SCRIPTSET_MAP
	    		where 1=1
	    		and SCRIPT_NAME = #{detail.SCRIPT_NAME};
	    		
	    		
	    		--// 02. delete firmware
	    		delete from CORONA_FIRMWARE_SCRIPT_MAP
	    		where 1=1
	    		and SCRIPT_NAME = #{detail.SCRIPT_NAME};
	    end;
    
    </update>
    
    
    <update id="dashboard.corona.firmware_script_map.update" parameterType="hashmap" >
    	declare
	    	cnt number;
	    begin
	    	
	    		select count(*) into cnt from CORONA_FIRMWARE_SCRIPT_MAP
	    		where 1=1
	    		<choose>
						<when test="searchJson != null and searchJson != '' and searchJson.origindatas.size() > 0 " >
			       		<foreach collection="searchJson.origindatas" item="item" index="index"  >
			       			and ${item.field} = #{item.value}
			       		</foreach>
			   		</when>
			   		<otherwise>
			   			and 1=2
			   		</otherwise>
		   		</choose>   
	    		;
	    		
	    		if cnt = 1 then
	              	update CORONA_FIRMWARE_SCRIPT_MAP set
	              	${fieldName} = #{fieldValue},	  
	              	MOD_DT = sysdate
	              	where 1=1
		    		<choose>
							<when test="searchJson != null and searchJson != '' and searchJson.origindatas.size() > 0 " >
				       		<foreach collection="searchJson.origindatas" item="item" index="index"  >
				       			and ${item.field} = #{item.value}
				       		</foreach>
				   		</when>
				   		<otherwise>
				   			and 1=2
				   		</otherwise>
			   		</choose>          	
	          		;
	        end if;
                
       	 
	    end;
    
    </update>
    <update id="dashboard.corona.firmware_script_map.insert" parameterType="hashmap" >
    	declare
	    	cnt number;
	    begin
	    	
	    		insert into CORONA_FIRMWARE_SCRIPT_MAP (FIRMWARE, SAMPLE, SCRIPT_NAME, CATEGORY, TEST_ITEM,INS_DT)
                values (#{FIRMWARE},#{SAMPLE},#{SCRIPT_NAME},#{CATEGORY},#{TEST_ITEM}, sysdate) ;
       	 
	    end;
    
    </update>
    <update id="dashboard.corona.firmware_script_map.delete.back" parameterType="hashmap" >
    	declare
	    	cnt number;
	    begin
	    		for rec in (
	    			with tbl_list as (
	    				select 'xxx' as firmware , 'xxx' as sample , 'xxx' as script_name  from dual
	    				<choose>
						<when test="searchJson != null and searchJson != '' and searchJson.delRows.size() > 0 " >
	    				<foreach collection="searchJson.delRows" item="item" index="index"  open=" union all  " separator=" union all " close=" ">
			       			select #{item.FIRMWARE} as firmware , #{item.SAMPLE} as sample , #{item.SCRIPT_NAME} as script_name  from dual
			       		</foreach>
			       		</when>
			       		</choose>
	    			)
	    			
	    			select * from tbl_list
	    			
	    		) loop 
	    			delete from CORONA_FIRMWARE_SCRIPT_MAP 
	    			where firmware = rec.firmware
	    			and sample = rec.sample
	    			and script_name = rec.script_name;
	    		
	    		end loop;
	    end;
    
    </update>
    <update id="dashboard.corona.firmware_script_map.delete" parameterType="hashmap" >
    	declare
	    	cnt number;
	    begin
	    		for rec in (
	    			with tbl_list as (
	    				select 'xxx' as firmware , 'xxx' as sample , 'xxx' as script_name  from dual
	    				union all
			       		select #{detail.FIRMWARE} as firmware , #{detail.SAMPLE} as sample , #{detail.SCRIPT_NAME} as script_name  from dual
	    			)
	    			
	    			select * from tbl_list
	    			
	    		) loop 
	    			delete from CORONA_FIRMWARE_SCRIPT_MAP 
	    			where firmware = rec.firmware
	    			and sample = rec.sample
	    			and script_name = rec.script_name;
	    		
	    		end loop;
	    end;
    
    </update>
    <update id="dashboard.corona.manage.script_copy.update" parameterType="hashmap" >
    	DECLARE
	    	cnt number;
	    	v_history_no varchar2(100);
	    BEGIN
	    		--// Revision Start
	    		SELECT LPAD(TO_NUMBER(nvl(max(HISTORY_NO),'0'))+1, 10,'0') into v_history_no  from  CORONA_HISTORY_NO;
	    		
	    		INSERT INTO CORONA_HISTORY_NO (HISTORY_NO, INS_DT) VALUES (v_history_no , sysdate );
	    		
	    		insert into CORONA_MAP_HISTORY (HISTORY_NO, FIRMWARE, SAMPLE, SCRIPT_NAME, CATEGORY, TEST_ITEM, SINGLE_MULTI, POWER_MODE_SPEED, TEST_TIME, NEED_VENDOR_CMD, LUCONFIG_YN, UFS_VER, TARGET_OPERATION, PRECONDITION, POR, HW_RESET, EP_RESET, H8, SSU, TARGET_LU, POWER_CONTROL, ITEM_NAME, ITEM_PURPOSE, ITEM_DESCRIPTION, INPUT_PARAMETER, SCRIPT_TAT_LVL, SCRIPT_VERSION, PF110, EXYNOS_7420, P4_REV, PRIORITY, TG645, USER_COMMENT, NEED_POWER_CYCLE, RESET_YN, SCRIPT_LVL, REFACTORING, RESET_TYPE, INS_DT, MOD_DT)
	    		select 
	    			v_history_no,
	    			FIRMWARE, SAMPLE, SCRIPT_NAME, CATEGORY, TEST_ITEM, SINGLE_MULTI, POWER_MODE_SPEED, TEST_TIME, NEED_VENDOR_CMD, LUCONFIG_YN, UFS_VER, TARGET_OPERATION, PRECONDITION, POR, HW_RESET, EP_RESET, H8, SSU, TARGET_LU, POWER_CONTROL, ITEM_NAME, ITEM_PURPOSE, ITEM_DESCRIPTION, INPUT_PARAMETER, SCRIPT_TAT_LVL, SCRIPT_VERSION, PF110, EXYNOS_7420, P4_REV, PRIORITY, TG645, USER_COMMENT, NEED_POWER_CYCLE, RESET_YN, SCRIPT_LVL, REFACTORING, RESET_TYPE, INS_DT, MOD_DT
	    		from CORONA_FIRMWARE_SCRIPT_MAP
	    		where firmware = #{searchJson.target.firmware}
	    		and sample = #{searchJson.target.sample} ;
	    
	    
	 			--// Copy Start   
	    		FOR rec in (
	    			select * from CORONA_SCRIPT_MASTER
					where 1=1
					and script_name in  <foreach collection="searchJson.selectedlist" item="item" index="index"  open="(" separator="," close=")">#{item.SCRIPT_NAME}</foreach>
	    			
	    		) LOOP 
	    			select count(*) into cnt from CORONA_FIRMWARE_SCRIPT_MAP
	    			where firmware = #{searchJson.target.firmware}
	    			and sample = #{searchJson.target.sample}
	    			and script_name = rec.script_name;
	    			
	    			IF cnt = 0 THEN
	    				insert into CORONA_FIRMWARE_SCRIPT_MAP (FIRMWARE, SAMPLE, SCRIPT_NAME, CATEGORY, TEST_ITEM, SINGLE_MULTI, POWER_MODE_SPEED, TEST_TIME, NEED_VENDOR_CMD, LUCONFIG_YN, UFS_VER, TARGET_OPERATION, PRECONDITION, POR, HW_RESET, EP_RESET, H8, SSU, TARGET_LU, POWER_CONTROL, ITEM_NAME, ITEM_PURPOSE, ITEM_DESCRIPTION, INPUT_PARAMETER, SCRIPT_TAT_LVL, SCRIPT_VERSION, PF110, EXYNOS_7420, P4_REV, PRIORITY, TG645, USER_COMMENT, NEED_POWER_CYCLE, RESET_YN, SCRIPT_LVL, REFACTORING, RESET_TYPE, INS_DT)
	    				values (
	    					#{searchJson.target.firmware} , #{searchJson.target.sample}
	    					, rec.SCRIPT_NAME, rec.CATEGORY, rec.TEST_ITEM, rec.SINGLE_MULTI, rec.POWER_MODE_SPEED, rec.TEST_TIME, rec.NEED_VENDOR_CMD, rec.LUCONFIG_YN, rec.UFS_VER, rec.TARGET_OPERATION, rec.PRECONDITION, rec.POR, rec.HW_RESET, rec.EP_RESET, rec.H8, rec.SSU, rec.TARGET_LU, rec.POWER_CONTROL, rec.ITEM_NAME, rec.ITEM_PURPOSE, rec.ITEM_DESCRIPTION, rec.INPUT_PARAMETER, rec.SCRIPT_TAT_LVL, rec.SCRIPT_VERSION, rec.PF110, rec.EXYNOS_7420, rec.P4_REV, rec.PRIORITY, rec.TG645, rec.USER_COMMENT, rec.NEED_POWER_CYCLE, rec.RESET_YN, rec.SCRIPT_LVL, rec.REFACTORING, rec.RESET_TYPE
	    					, sysdate
	    				);
	    			ELSE
	    				UPDATE CORONA_FIRMWARE_SCRIPT_MAP SET
	    				
							CATEGORY = rec.CATEGORY,
							TEST_ITEM = rec.TEST_ITEM,
							SINGLE_MULTI = rec.SINGLE_MULTI,
							POWER_MODE_SPEED = rec.POWER_MODE_SPEED,
							TEST_TIME = rec.TEST_TIME,
							NEED_VENDOR_CMD = rec.NEED_VENDOR_CMD,
							LUCONFIG_YN = rec.LUCONFIG_YN,
							UFS_VER = rec.UFS_VER,
							TARGET_OPERATION = rec.TARGET_OPERATION,
							PRECONDITION = rec.PRECONDITION,
							POR = rec.POR,
							HW_RESET = rec.HW_RESET,
							EP_RESET = rec.EP_RESET,
							H8 = rec.H8,
							SSU = rec.SSU,
							TARGET_LU = rec.TARGET_LU,
							POWER_CONTROL = rec.POWER_CONTROL,
							ITEM_NAME = rec.ITEM_NAME,
							ITEM_PURPOSE = rec.ITEM_PURPOSE,
							ITEM_DESCRIPTION = rec.ITEM_DESCRIPTION,
							INPUT_PARAMETER = rec.INPUT_PARAMETER,
							SCRIPT_TAT_LVL = rec.SCRIPT_TAT_LVL,
							SCRIPT_VERSION = rec.SCRIPT_VERSION,
							PF110 = rec.PF110,
							EXYNOS_7420 = rec.EXYNOS_7420,
							P4_REV = rec.P4_REV,
							PRIORITY = rec.PRIORITY,
							TG645 = rec.TG645,
							USER_COMMENT = rec.USER_COMMENT,
							NEED_POWER_CYCLE = rec.NEED_POWER_CYCLE,
							RESET_YN = rec.RESET_YN,
							SCRIPT_LVL = rec.SCRIPT_LVL,
							REFACTORING = rec.REFACTORING,
							RESET_TYPE = rec.RESET_TYPE,
							MOD_DT = sysdate
							
	    				WHERE firmware = #{searchJson.target.firmware}
		    			AND sample = #{searchJson.target.sample}
		    			AND script_name = rec.script_name; 
		    			
		    			
	    			END IF;
	    		
	    		END LOOP;
	    END;
    
    </update>
    
    <select id="dashboard.corona.historyno" resultType="hashmap">
		SELECT LPAD(TO_NUMBER(nvl(max(HISTORY_NO),'0'))+1, 10,'0') HISTORY_NO from  CORONA_HISTORY_NO
    </select>
    <update id="dashboard.corona.manage.insert.historyno.copy_template_project" parameterType="hashmap" >
    	DECLARE
	    	cnt number;
	    	v_history_no varchar2(100) := #{history_no};
	    BEGIN
	    	INSERT INTO CORONA_HISTORY_NO (HISTORY_NO, INS_DT) VALUES (v_history_no , sysdate );
	    	insert into CORONA_MAP_HISTORY (HISTORY_NO, FIRMWARE, SAMPLE, SCRIPT_NAME, CATEGORY, TEST_ITEM, SINGLE_MULTI, POWER_MODE_SPEED, TEST_TIME, NEED_VENDOR_CMD, LUCONFIG_YN, UFS_VER, TARGET_OPERATION, PRECONDITION, POR, HW_RESET, EP_RESET, H8, SSU, TARGET_LU, POWER_CONTROL, ITEM_NAME, ITEM_PURPOSE, ITEM_DESCRIPTION, INPUT_PARAMETER, SCRIPT_TAT_LVL, SCRIPT_VERSION, PF110, EXYNOS_7420, P4_REV, PRIORITY, TG645, USER_COMMENT, NEED_POWER_CYCLE, RESET_YN, SCRIPT_LVL, REFACTORING, RESET_TYPE, INS_DT, MOD_DT)
	    		select 
	    			v_history_no,
	    			FIRMWARE, SAMPLE, SCRIPT_NAME, CATEGORY, TEST_ITEM, SINGLE_MULTI, POWER_MODE_SPEED, TEST_TIME, NEED_VENDOR_CMD, LUCONFIG_YN, UFS_VER, TARGET_OPERATION, PRECONDITION, POR, HW_RESET, EP_RESET, H8, SSU, TARGET_LU, POWER_CONTROL, ITEM_NAME, ITEM_PURPOSE, ITEM_DESCRIPTION, INPUT_PARAMETER, SCRIPT_TAT_LVL, SCRIPT_VERSION, PF110, EXYNOS_7420, P4_REV, PRIORITY, TG645, USER_COMMENT, NEED_POWER_CYCLE, RESET_YN, SCRIPT_LVL, REFACTORING, RESET_TYPE, INS_DT, MOD_DT
	    		from CORONA_FIRMWARE_SCRIPT_MAP
	    		where 1=1
	    		and sample = #{searchJson.target.sample} ;
	    End;
    </update>
    <update id="dashboard.corona.manage.insert.historyno.copy_template_firmware" parameterType="hashmap" >
    	DECLARE
	    	cnt number;
	    	v_history_no varchar2(100) := #{history_no};
	    BEGIN
	    	INSERT INTO CORONA_HISTORY_NO (HISTORY_NO, INS_DT) VALUES (v_history_no , sysdate );
	    	insert into CORONA_MAP_HISTORY (HISTORY_NO, FIRMWARE, SAMPLE, SCRIPT_NAME, CATEGORY, TEST_ITEM, SINGLE_MULTI, POWER_MODE_SPEED, TEST_TIME, NEED_VENDOR_CMD, LUCONFIG_YN, UFS_VER, TARGET_OPERATION, PRECONDITION, POR, HW_RESET, EP_RESET, H8, SSU, TARGET_LU, POWER_CONTROL, ITEM_NAME, ITEM_PURPOSE, ITEM_DESCRIPTION, INPUT_PARAMETER, SCRIPT_TAT_LVL, SCRIPT_VERSION, PF110, EXYNOS_7420, P4_REV, PRIORITY, TG645, USER_COMMENT, NEED_POWER_CYCLE, RESET_YN, SCRIPT_LVL, REFACTORING, RESET_TYPE, INS_DT, MOD_DT)
	    		select 
	    			v_history_no,
	    			FIRMWARE, SAMPLE, SCRIPT_NAME, CATEGORY, TEST_ITEM, SINGLE_MULTI, POWER_MODE_SPEED, TEST_TIME, NEED_VENDOR_CMD, LUCONFIG_YN, UFS_VER, TARGET_OPERATION, PRECONDITION, POR, HW_RESET, EP_RESET, H8, SSU, TARGET_LU, POWER_CONTROL, ITEM_NAME, ITEM_PURPOSE, ITEM_DESCRIPTION, INPUT_PARAMETER, SCRIPT_TAT_LVL, SCRIPT_VERSION, PF110, EXYNOS_7420, P4_REV, PRIORITY, TG645, USER_COMMENT, NEED_POWER_CYCLE, RESET_YN, SCRIPT_LVL, REFACTORING, RESET_TYPE, INS_DT, MOD_DT
	    		from CORONA_FIRMWARE_SCRIPT_MAP
	    		where 1=1
	    		and sample = #{searchJson.target.sample}
	    		and firmware = #{searchJson.target.firmware}
	    		 ;
	    End;
    </update>
    <update id="dashboard.corona.manage.insert.historyno.copy_firmware_firmware" parameterType="hashmap" >
    	DECLARE
	    	cnt number;
	    	v_history_no varchar2(100) := #{history_no};
	    BEGIN
	    	INSERT INTO CORONA_HISTORY_NO (HISTORY_NO, INS_DT) VALUES (v_history_no , sysdate );
	    	insert into CORONA_MAP_HISTORY (HISTORY_NO, FIRMWARE, SAMPLE, SCRIPT_NAME, CATEGORY, TEST_ITEM, SINGLE_MULTI, POWER_MODE_SPEED, TEST_TIME, NEED_VENDOR_CMD, LUCONFIG_YN, UFS_VER, TARGET_OPERATION, PRECONDITION, POR, HW_RESET, EP_RESET, H8, SSU, TARGET_LU, POWER_CONTROL, ITEM_NAME, ITEM_PURPOSE, ITEM_DESCRIPTION, INPUT_PARAMETER, SCRIPT_TAT_LVL, SCRIPT_VERSION, PF110, EXYNOS_7420, P4_REV, PRIORITY, TG645, USER_COMMENT, NEED_POWER_CYCLE, RESET_YN, SCRIPT_LVL, REFACTORING, RESET_TYPE, INS_DT, MOD_DT)
	    		select 
	    			v_history_no,
	    			FIRMWARE, SAMPLE, SCRIPT_NAME, CATEGORY, TEST_ITEM, SINGLE_MULTI, POWER_MODE_SPEED, TEST_TIME, NEED_VENDOR_CMD, LUCONFIG_YN, UFS_VER, TARGET_OPERATION, PRECONDITION, POR, HW_RESET, EP_RESET, H8, SSU, TARGET_LU, POWER_CONTROL, ITEM_NAME, ITEM_PURPOSE, ITEM_DESCRIPTION, INPUT_PARAMETER, SCRIPT_TAT_LVL, SCRIPT_VERSION, PF110, EXYNOS_7420, P4_REV, PRIORITY, TG645, USER_COMMENT, NEED_POWER_CYCLE, RESET_YN, SCRIPT_LVL, REFACTORING, RESET_TYPE, INS_DT, MOD_DT
	    		from CORONA_FIRMWARE_SCRIPT_MAP
	    		where 1=1
	    		and sample = #{searchJson.target.sample}
	    		and firmware = #{searchJson.target.firmware}
	    		 ;
	    End;
    </update>
    
    <update id="dashboard.corona.manage.script_copy_project.update" parameterType="hashmap" >
    	DECLARE
	    	cnt number;
	    	v_history_no varchar2(100) := #{history_no};
	    BEGIN
	    		
	    	--// Revision Start	    		
	    	For rec_firmware in (
	    		select distinct firmware from CORONA_FIRMWARE_MASTER where sample = #{searchJson.target.sample}
	    	) Loop
	    		
	    		--// second Loop
	    		FOR rec in (
	    			select * from CORONA_SCRIPT_MASTER
					where 1=1
					and script_name = #{detail.SCRIPT_NAME}    			
	    		) LOOP 
		    		
			    			
					select count(*) into cnt from CORONA_FIRMWARE_SCRIPT_MAP
					where firmware = rec_firmware.firmware
					and sample = #{searchJson.target.sample}
					and script_name = rec.SCRIPT_NAME;
					
					IF cnt = 0 THEN
						insert into CORONA_FIRMWARE_SCRIPT_MAP (FIRMWARE, SAMPLE, SCRIPT_NAME, CATEGORY, TEST_ITEM, SINGLE_MULTI, POWER_MODE_SPEED, TEST_TIME, NEED_VENDOR_CMD, LUCONFIG_YN, UFS_VER, TARGET_OPERATION, PRECONDITION, POR, HW_RESET, EP_RESET, H8, SSU, TARGET_LU, POWER_CONTROL, ITEM_NAME, ITEM_PURPOSE, ITEM_DESCRIPTION, INPUT_PARAMETER, SCRIPT_TAT_LVL, SCRIPT_VERSION, PF110, EXYNOS_7420, P4_REV, PRIORITY, TG645, USER_COMMENT, NEED_POWER_CYCLE, RESET_YN, SCRIPT_LVL, REFACTORING, RESET_TYPE, INS_DT)
						values (
							rec_firmware.firmware , #{searchJson.target.sample}
							, rec.SCRIPT_NAME, rec.CATEGORY, rec.TEST_ITEM, rec.SINGLE_MULTI, rec.POWER_MODE_SPEED, rec.TEST_TIME, rec.NEED_VENDOR_CMD, rec.LUCONFIG_YN, rec.UFS_VER, rec.TARGET_OPERATION, rec.PRECONDITION, rec.POR, rec.HW_RESET, rec.EP_RESET, rec.H8, rec.SSU, rec.TARGET_LU, rec.POWER_CONTROL, rec.ITEM_NAME, rec.ITEM_PURPOSE, rec.ITEM_DESCRIPTION, rec.INPUT_PARAMETER, rec.SCRIPT_TAT_LVL, rec.SCRIPT_VERSION, rec.PF110, rec.EXYNOS_7420, rec.P4_REV, rec.PRIORITY, rec.TG645, rec.USER_COMMENT, rec.NEED_POWER_CYCLE, rec.RESET_YN, rec.SCRIPT_LVL, rec.REFACTORING, rec.RESET_TYPE
							, sysdate
						);
					ELSE
					
						UPDATE CORONA_FIRMWARE_SCRIPT_MAP SET						
							CATEGORY = rec.CATEGORY,
							TEST_ITEM = rec.TEST_ITEM,
							SINGLE_MULTI = rec.SINGLE_MULTI,
							POWER_MODE_SPEED = rec.POWER_MODE_SPEED,
							TEST_TIME = rec.TEST_TIME,
							NEED_VENDOR_CMD = rec.NEED_VENDOR_CMD,
							LUCONFIG_YN = rec.LUCONFIG_YN,
							UFS_VER = rec.UFS_VER,
							TARGET_OPERATION = rec.TARGET_OPERATION,
							PRECONDITION = rec.PRECONDITION,
							POR = rec.POR,
							HW_RESET = rec.HW_RESET,
							EP_RESET = rec.EP_RESET,
							H8 = rec.H8,
							SSU = rec.SSU,
							TARGET_LU = rec.TARGET_LU,
							POWER_CONTROL = rec.POWER_CONTROL,
							ITEM_NAME = rec.ITEM_NAME,
							ITEM_PURPOSE = rec.ITEM_PURPOSE,
							ITEM_DESCRIPTION = rec.ITEM_DESCRIPTION,
							INPUT_PARAMETER = rec.INPUT_PARAMETER,
							SCRIPT_TAT_LVL = rec.SCRIPT_TAT_LVL,
							SCRIPT_VERSION = rec.SCRIPT_VERSION,
							PF110 = rec.PF110,
							EXYNOS_7420 = rec.EXYNOS_7420,
							P4_REV = rec.P4_REV,
							PRIORITY = rec.PRIORITY,
							TG645 = rec.TG645,
							USER_COMMENT = rec.USER_COMMENT,
							NEED_POWER_CYCLE = rec.NEED_POWER_CYCLE,
							RESET_YN = rec.RESET_YN,
							SCRIPT_LVL = rec.SCRIPT_LVL,
							REFACTORING = rec.REFACTORING,
							RESET_TYPE = rec.RESET_TYPE,
							MOD_DT = sysdate
				
						WHERE firmware = rec_firmware.firmware
						AND sample = #{searchJson.target.sample}
						AND script_name = rec.script_name; 
						
						
					END IF;
					
				End Loop;
	    	
	    	End Loop;
	    	 
	    	
	    		
	    	
	 			
	    END;
    
    </update>
    
    <update id="dashboard.corona.manage.script_copy_firmware.update" parameterType="hashmap" >
    	DECLARE
	    	cnt number;
	    	v_history_no varchar2(100) := #{history_no};
	    BEGIN
	    		
	    	--// Revision Start	    		
	    	For rec_firmware in (
	    		select distinct firmware from CORONA_FIRMWARE_MASTER where sample = #{searchJson.target.sample} and firmware = #{searchJson.target.firmware} 
	    	) Loop
	    		
	    		--// second Loop
	    		FOR rec in (
	    			select * from CORONA_SCRIPT_MASTER
					where 1=1
					and script_name = #{detail.SCRIPT_NAME}    			
	    		) LOOP 
		    		
			    			
					select count(*) into cnt from CORONA_FIRMWARE_SCRIPT_MAP
					where firmware = rec_firmware.firmware
					and sample = #{searchJson.target.sample}
					and script_name = rec.SCRIPT_NAME;
					
					IF cnt = 0 THEN
						insert into CORONA_FIRMWARE_SCRIPT_MAP (FIRMWARE, SAMPLE, SCRIPT_NAME, CATEGORY, TEST_ITEM, SINGLE_MULTI, POWER_MODE_SPEED, TEST_TIME, NEED_VENDOR_CMD, LUCONFIG_YN, UFS_VER, TARGET_OPERATION, PRECONDITION, POR, HW_RESET, EP_RESET, H8, SSU, TARGET_LU, POWER_CONTROL, ITEM_NAME, ITEM_PURPOSE, ITEM_DESCRIPTION, INPUT_PARAMETER, SCRIPT_TAT_LVL, SCRIPT_VERSION, PF110, EXYNOS_7420, P4_REV, PRIORITY, TG645, USER_COMMENT, NEED_POWER_CYCLE, RESET_YN, SCRIPT_LVL, REFACTORING, RESET_TYPE, INS_DT)
						values (
							rec_firmware.firmware , #{searchJson.target.sample}
							, rec.SCRIPT_NAME, rec.CATEGORY, rec.TEST_ITEM, rec.SINGLE_MULTI, rec.POWER_MODE_SPEED, rec.TEST_TIME, rec.NEED_VENDOR_CMD, rec.LUCONFIG_YN, rec.UFS_VER, rec.TARGET_OPERATION, rec.PRECONDITION, rec.POR, rec.HW_RESET, rec.EP_RESET, rec.H8, rec.SSU, rec.TARGET_LU, rec.POWER_CONTROL, rec.ITEM_NAME, rec.ITEM_PURPOSE, rec.ITEM_DESCRIPTION, rec.INPUT_PARAMETER, rec.SCRIPT_TAT_LVL, rec.SCRIPT_VERSION, rec.PF110, rec.EXYNOS_7420, rec.P4_REV, rec.PRIORITY, rec.TG645, rec.USER_COMMENT, rec.NEED_POWER_CYCLE, rec.RESET_YN, rec.SCRIPT_LVL, rec.REFACTORING, rec.RESET_TYPE
							, sysdate
						);
					ELSE
					
						UPDATE CORONA_FIRMWARE_SCRIPT_MAP SET						
							CATEGORY = rec.CATEGORY,
							TEST_ITEM = rec.TEST_ITEM,
							SINGLE_MULTI = rec.SINGLE_MULTI,
							POWER_MODE_SPEED = rec.POWER_MODE_SPEED,
							TEST_TIME = rec.TEST_TIME,
							NEED_VENDOR_CMD = rec.NEED_VENDOR_CMD,
							LUCONFIG_YN = rec.LUCONFIG_YN,
							UFS_VER = rec.UFS_VER,
							TARGET_OPERATION = rec.TARGET_OPERATION,
							PRECONDITION = rec.PRECONDITION,
							POR = rec.POR,
							HW_RESET = rec.HW_RESET,
							EP_RESET = rec.EP_RESET,
							H8 = rec.H8,
							SSU = rec.SSU,
							TARGET_LU = rec.TARGET_LU,
							POWER_CONTROL = rec.POWER_CONTROL,
							ITEM_NAME = rec.ITEM_NAME,
							ITEM_PURPOSE = rec.ITEM_PURPOSE,
							ITEM_DESCRIPTION = rec.ITEM_DESCRIPTION,
							INPUT_PARAMETER = rec.INPUT_PARAMETER,
							SCRIPT_TAT_LVL = rec.SCRIPT_TAT_LVL,
							SCRIPT_VERSION = rec.SCRIPT_VERSION,
							PF110 = rec.PF110,
							EXYNOS_7420 = rec.EXYNOS_7420,
							P4_REV = rec.P4_REV,
							PRIORITY = rec.PRIORITY,
							TG645 = rec.TG645,
							USER_COMMENT = rec.USER_COMMENT,
							NEED_POWER_CYCLE = rec.NEED_POWER_CYCLE,
							RESET_YN = rec.RESET_YN,
							SCRIPT_LVL = rec.SCRIPT_LVL,
							REFACTORING = rec.REFACTORING,
							RESET_TYPE = rec.RESET_TYPE,
							MOD_DT = sysdate
				
						WHERE firmware = rec_firmware.firmware
						AND sample = #{searchJson.target.sample}
						AND script_name = rec.script_name; 
						
						
					END IF;
					
				End Loop;
	    	
	    	End Loop;
	    	 
	    	
	    		
	    	
	 			
	    END;
    
    </update>
    <update id="dashboard.corona.manage.firmware_copy_firmware.update" parameterType="hashmap" >
    	DECLARE
	    	cnt number;
	    	v_history_no varchar2(100) := #{history_no};
	    BEGIN
	    		
	    	--// Revision Start	    		
	    	For rec_firmware in (
	    		select distinct firmware from CORONA_FIRMWARE_MASTER where sample = #{searchJson.target.sample} and firmware = #{searchJson.target.firmware} 
	    	) Loop
	    		
	    		--// second Loop
	    		FOR rec in (
	    			select * from CORONA_FIRMWARE_SCRIPT_MAP
					where 1=1
					and firmware = #{detail.FIRMWARE}
					and sample = #{detail.SAMPLE}
					and script_name = #{detail.SCRIPT_NAME}    			
	    		) LOOP 
		    		
			    			
					select count(*) into cnt from CORONA_FIRMWARE_SCRIPT_MAP
					where firmware = rec_firmware.firmware
					and sample = #{searchJson.target.sample}
					and script_name = rec.SCRIPT_NAME;
					
					IF cnt = 0 THEN
						insert into CORONA_FIRMWARE_SCRIPT_MAP (FIRMWARE, SAMPLE, SCRIPT_NAME, CATEGORY, TEST_ITEM, SINGLE_MULTI, POWER_MODE_SPEED, TEST_TIME, NEED_VENDOR_CMD, LUCONFIG_YN, UFS_VER, TARGET_OPERATION, PRECONDITION, POR, HW_RESET, EP_RESET, H8, SSU, TARGET_LU, POWER_CONTROL, ITEM_NAME, ITEM_PURPOSE, ITEM_DESCRIPTION, INPUT_PARAMETER, SCRIPT_TAT_LVL, SCRIPT_VERSION, PF110, EXYNOS_7420, P4_REV, PRIORITY, TG645, USER_COMMENT, NEED_POWER_CYCLE, RESET_YN, SCRIPT_LVL, REFACTORING, RESET_TYPE, INS_DT)
						values (
							rec_firmware.firmware , #{searchJson.target.sample}
							, rec.SCRIPT_NAME, rec.CATEGORY, rec.TEST_ITEM, rec.SINGLE_MULTI, rec.POWER_MODE_SPEED, rec.TEST_TIME, rec.NEED_VENDOR_CMD, rec.LUCONFIG_YN, rec.UFS_VER, rec.TARGET_OPERATION, rec.PRECONDITION, rec.POR, rec.HW_RESET, rec.EP_RESET, rec.H8, rec.SSU, rec.TARGET_LU, rec.POWER_CONTROL, rec.ITEM_NAME, rec.ITEM_PURPOSE, rec.ITEM_DESCRIPTION, rec.INPUT_PARAMETER, rec.SCRIPT_TAT_LVL, rec.SCRIPT_VERSION, rec.PF110, rec.EXYNOS_7420, rec.P4_REV, rec.PRIORITY, rec.TG645, rec.USER_COMMENT, rec.NEED_POWER_CYCLE, rec.RESET_YN, rec.SCRIPT_LVL, rec.REFACTORING, rec.RESET_TYPE
							, sysdate
						);
					ELSE
					
						UPDATE CORONA_FIRMWARE_SCRIPT_MAP SET						
							CATEGORY = rec.CATEGORY,
							TEST_ITEM = rec.TEST_ITEM,
							SINGLE_MULTI = rec.SINGLE_MULTI,
							POWER_MODE_SPEED = rec.POWER_MODE_SPEED,
							TEST_TIME = rec.TEST_TIME,
							NEED_VENDOR_CMD = rec.NEED_VENDOR_CMD,
							LUCONFIG_YN = rec.LUCONFIG_YN,
							UFS_VER = rec.UFS_VER,
							TARGET_OPERATION = rec.TARGET_OPERATION,
							PRECONDITION = rec.PRECONDITION,
							POR = rec.POR,
							HW_RESET = rec.HW_RESET,
							EP_RESET = rec.EP_RESET,
							H8 = rec.H8,
							SSU = rec.SSU,
							TARGET_LU = rec.TARGET_LU,
							POWER_CONTROL = rec.POWER_CONTROL,
							ITEM_NAME = rec.ITEM_NAME,
							ITEM_PURPOSE = rec.ITEM_PURPOSE,
							ITEM_DESCRIPTION = rec.ITEM_DESCRIPTION,
							INPUT_PARAMETER = rec.INPUT_PARAMETER,
							SCRIPT_TAT_LVL = rec.SCRIPT_TAT_LVL,
							SCRIPT_VERSION = rec.SCRIPT_VERSION,
							PF110 = rec.PF110,
							EXYNOS_7420 = rec.EXYNOS_7420,
							P4_REV = rec.P4_REV,
							PRIORITY = rec.PRIORITY,
							TG645 = rec.TG645,
							USER_COMMENT = rec.USER_COMMENT,
							NEED_POWER_CYCLE = rec.NEED_POWER_CYCLE,
							RESET_YN = rec.RESET_YN,
							SCRIPT_LVL = rec.SCRIPT_LVL,
							REFACTORING = rec.REFACTORING,
							RESET_TYPE = rec.RESET_TYPE,
							MOD_DT = sysdate
				
						WHERE firmware = rec_firmware.firmware
						AND sample = #{searchJson.target.sample}
						AND script_name = rec.script_name; 
						
						
					END IF;
					
				End Loop;
	    	
	    	End Loop;
	    	 
	    	
	    		
	    	
	 			
	    END;
    
    </update>
    <update id="dashbaord.corona.firmware.status.edit" parameterType="hashmap">
    	declare
	    	cnt number;
	    	vStatus varchar2(10) := #{STATUS};
	    	vStatus1 varchar2(10) ;
	    begin
	    		
	    		select count(*) into cnt from CORONA_FIRMWARE_SCRIPT_MAP
	    		where FIRMWARE = #{origindata.FIRMWARE}
                and  SAMPLE = #{origindata.SAMPLE}
                and  SCRIPT_NAME = #{origindata.SCRIPT_NAME_META} ;
	    		
	    		if cnt = 1 then
	    			if vStatus = 'Not Yet' then 
	    				vStatus1 := '';
	    			else
	    				vStatus1 := vStatus;
	    			end if;
	    		
	                update CORONA_FIRMWARE_SCRIPT_MAP set
	                	STATUS = vStatus1, 
	                	JIRA = #{JIRA},
	                	USER_COMMENT = USER_COMMENT || chr(10) || to_char(sysdate,'YYYY-MM-DD HH24:MI') || ': ' || STATUS || ' ==> ' || #{STATUS} || ' ( ${userId} )'  ,
	  
	                	MOD_DT = sysdate
	                where FIRMWARE = #{origindata.FIRMWARE}
	                and  SAMPLE = #{origindata.SAMPLE}
	                and  SCRIPT_NAME = #{origindata.SCRIPT_NAME_META} ;
	                
	          	end if;
                
       	 
	    end;
    
    </update>
    <update id="dashbaord.corona.firmware.log.status.edit" parameterType="hashmap">
    	declare
	    	cnt number;
	    	vStatus varchar2(10) := #{STATUS};
	    	vStatus1 varchar2(10) ;
	    begin
	    		
	    		select count(*) into cnt from CORONA_TEST_DETAIL
	    		where 1=1
                and  SAMPLE = #{origindata.SAMPLE}
                and FIRMWARE = #{origindata.FIRMWARE}
                and SCRIPT = #{origindata.SCRIPT}
                and YYYYMM = #{origindata.YYYYMM}
                and TEST_BOARD = #{origindata.TEST_BOARD}
                and  SCRIPT_NAME = #{origindata.SCRIPT_NAME}
                and  SAMPLE_NUMBER = #{origindata.SAMPLE_NUMBER};                
	    		
	    		if cnt = 1 then
	    			if vStatus = 'Not Yet' then 
	    				vStatus1 := '';
	    			else
	    				vStatus1 := vStatus;
	    			end if;
	    		
	                update CORONA_TEST_DETAIL set
	                	STATUS = vStatus1, 
	                	MOD_DT = sysdate
	                where  SAMPLE = #{origindata.SAMPLE}
	                and FIRMWARE = #{origindata.FIRMWARE}
	                and SCRIPT = #{origindata.SCRIPT}
	                and YYYYMM = #{origindata.YYYYMM}
	                and TEST_BOARD = #{origindata.TEST_BOARD}
	                and  SCRIPT_NAME = #{origindata.SCRIPT_NAME}
	                and  SAMPLE_NUMBER = #{origindata.SAMPLE_NUMBER};                
	                
	          	end if;
                
       	 
	    end;
    
    </update>
    
    <update id="dashboard.corona.manage.firmware.status.update" parameterType="hashmap">
    	declare
			v_status varchar2(10);
		
		begin	
			
			-- start firmware status
			-- 01. firmware script list
			for rec in (
				select
					FIRMWARE,SAMPLE, SCRIPT_NAME
				from CORONA_FIRMWARE_SCRIPT_MAP
				where sample = #{sample}
				and FIRMWARE = #{firmware}	 
				--order by FIRMWARE, SAMPLE, SCRIPT_NAME
			) loop
			-- 02. detail log list , determine status
				v_status := '';
				for rec1 in (
					select
						STATUS
					from CORONA_TEST_DETAIL a
					where a.sample= rec.sample
					and a.firmware = rec.firmware
					and a.script = rec.script_name
					order by YYYYMM
				) loop
					v_status := rec1.STATUS;
					if rec1.STATUS = 'FAIL' then 
						exit;
					end if;
				end loop;
				
				update CORONA_FIRMWARE_SCRIPT_MAP set
					status = v_status,
					USER_COMMENT = USER_COMMENT || chr(10) || to_char(sysdate,'YYYY-MM-DD HH24:MI') || ': ' || STATUS || ' ==> ' || v_status || ' (management) ',
					MOD_DT = sysdate
				where firmware = rec.firmware
				and sample= rec.sample
				and script_name = rec.script_name;
				
			end loop;
			
			
		end;
    
    
    </update>
    
    <select id="dashboard.corona.autocomplete.script" resultType="hashmap">
		select
			distinct ${field} "id", ${field} "name"
		from CORONA_SCRIPT_MASTER
		where REGEXP_LIKE(${field} ,#{term},'i')  
		order by 1
	
	</select>
	
	<select id="dashboard.corona.project.useYn" resultType="hashmap">
		with tbl_project as (
			select distinct sample as project from CORONA_FIRMWARE_MASTER			
		)
		
		select a.* from (
			select
				a.project as project,
				b.USE_YN,
				nvl(b.SCRIPTSET,'Normal') as SCRIPTSET
			from tbl_project a
			left outer join CORONA_PROJECT  b
				on a.project = b.project
			
		) A
		where 1=1
		<choose>
					<when test="filters != null and filters != ''  and filters.rules.size() > 0 " >
			       		<foreach collection="filters.rules" item="item" index="index"  >
			           		and REGEXP_LIKE(${item.field},#{item.data},'i') 
			       		</foreach>
			   		</when>
			   		<otherwise>
			   		</otherwise>
		   		</choose>
		order by a.project
		
	
	</select>
	
	<select id="dashboard.corona.project.useYn.page" resultType="hashmap">
		with tbl_project as (
			select distinct sample as project from CORONA_FIRMWARE_MASTER			
		)
		
		select 
				ceil(count(*)/ #{rows} ) as total,
				#{page} as page ,
				count(*) records 
			from 
			(
				select a.* from (
					select
						a.project as project,
						b.USE_YN,
						b.SCRIPTSET
					from tbl_project a
					left outer join CORONA_PROJECT  b
						on a.project = b.project
					order by a.project
			) A
				where 1=1
				<choose>
					<when test="filters != null and filters != ''  and filters.rules.size() > 0 " >
			       		<foreach collection="filters.rules" item="item" index="index"  >
			           		and REGEXP_LIKE(${item.field},#{item.data},'i') 
			       		</foreach>
			   		</when>
			   		<otherwise>
			   		</otherwise>
		   		</choose>
			)
	
	</select>
	
	<update id="dashbaord.corona.project.useYn.edit" parameterType="hashmap">
    	declare
	    	cnt number;
	    	vUseyn varchar2(10) := #{USE_YN};
	    begin
	    		
	    		select count(*) into cnt from CORONA_PROJECT
	    		where PROJECT = #{origindata.PROJECT} ;
	    		
	    		if cnt = 0 then
	    			insert into CORONA_PROJECT(PROJECT, USE_YN, SCRIPTSET, INS_DT)
	    			values (#{origindata.PROJECT},#{USE_YN}, #{SCRIPTSET}, sysdate);
	    		else	    		
	                update CORONA_PROJECT set
	                	USE_YN = vUseyn, 
	                	SCRIPTSET = #{SCRIPTSET} ,
	                	MOD_DT = sysdate
	               where PROJECT = #{origindata.PROJECT} ;
	                
	          	end if;
                
       	 
	    end;
    
    </update>
	
	<select id="dashboard.corona.summay.firmware.pms" resultType="hashmap">
		select 
			a.SAMPLE,
			a.FIRMWARE,
			b.FW_VERSION
			
		from CORONA_FIRMWARE_MASTER A
		join SOLUTIONPMS.FW_RELEASE b
			on A.firmware = b.fw_version
			and (SELECT CASE WHEN CODE_ID = 'SPM_00005011' THEN 'eMMC' ELSE 'SSD' END FROM SOLUTIONPMS.PJT_BASE_INFO WHERE CODE_NAME = 'Application' AND PJT_ID = B.PJT_ID) != 'SSD'
			and SOLUTIONPMS.FN_CODE_VALUE_ID(b.VERIFY_RESULT_CD) = 'Pass'
			and SOLUTIONPMS.FN_CODE_VALUE_ID(b.RELEASE_STATUS_CD) != 'Cancelled'
			and NVL(b.OVT_YN, 'N') = 'N'		
		where 1=1
		<if test="project  != null and project != '' ">
		and a.sample = #{project}
		</if>
	
	</select>
    
</mapper>    